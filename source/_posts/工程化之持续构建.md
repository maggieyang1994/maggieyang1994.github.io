---
title: 工程化之持续构建
date: 2019-08-15
categories: 
- 前端工程化
rank: 3
tags: 
  - heroku
  - Travis
  - 前端工程化
  - 自动构建
---


#### 	[ Travis](https://docs.travis-ci.com)用于部署前端代码
  **概念**： 持续集成服务， 用于绑定gitHub上的项目， 一旦项目push到指定分支,  就会自动捕捉到，然后进行测试和构建， 最后还可以帮你部署到服务器。
**步骤**: 
 - 登陆到[官网](travis-ci.org)， 选择你要绑定的github仓库
 - 在项目根目录下新建一个travis.yml,这个文件制定了travis的行为
    
  ``` 
//指定语言
language:node_js                   
//语言版本
node_js:
	- '8.11.3' 
// 执行脚本 默认是npm test                       
script: npm run build
// 安装依赖  默认              
install: npm install                 
after_sucess: cp -i ./dist/index.html ./dist/404.html
// 缓存node_moduels
cache:
	directories: node_modules
// 部署到github pages         
deploy:
	provider: pages
  // 部署成功之后保留构建成功的文件                    
	skip_cleanup: true				  
	email: maggieyang1994@gmail.com
	github_token: $PUBLISH_TOKEN  
	keep_history: true
  // push到github  gh_pages分支上的路径
	local_dir: ./dist
  // 监测master分支的改动               
	on:branch: master                
	target_branch: gh_pages

```
  #####  其中deploy的配置项github_token:
   因为构建完成后travis会将构建成功之后的dist目录push到gh_pages, 需要有github的push的权限，在[这里](https://github.com/settings/tokens)生成，保存到travis的[环境变量](https://travis-ci.org/maggieyang1994/yirenzhixia/settings)里，在这里就可以使用
   
   
 - 执行步骤： install ---> script ---> deploy
 - ***注意***：构建之后放在github服务器之后， 一切路径都会带上仓库名
 ```
  // index/router
  export default new Router({
    mode: "history",
    base: "/yirenzhixia/"   //加上基路劲
    ...
  }) 


   // index/config.js
    export defalt = {
     build: {
      index: Path.resolve("dirname", "../dist/index.thml");
      assetsRoot： Path.resolve("dirname", "..dist")
      assetsPublicPath: "/yirenzhixia/"  默认是/  修改公共路径
     }
    }
 ```
##### 因为travis构建之后将gh-pages当成了静态目录，所以不能处理路由，在地址栏直接访问详情页的时候会出现404页面，所以要么在travis.yml中在after_sucesss也就是script完成之后， 将生成的index.html复制一份到404.html到当前路径，相当于重定向。或者将路由的mode改成hash


### [Heroku](https://devcenter.heroku.com/articles/getting-started-with-nodejs)用于部署后台代码
### 概念： 一种限量免费的云服务， 用来托管后台项目
#### 步骤： 

 1. 下载heroku, 在命令行输入heroku login,之后会进入登陆页面，heroku的身份验证
 2. 有两种方式可以新建一个heroku项目
  - 命令行：  
								 1. 进入到项目根路径 heroku create(创建一个heroku应用和一个空的仓库， 将本地git仓库与heroku仓库关联)
								 2. git push heroku master（将本地仓库的代码push到heroku仓库）（每次更新需要手动运行）
								 3. 项目根路径新建Procfile, web: node bin/www   start you app的命令语句
								 4. 修改端口
```
	// 由于heroku会自动随机分配一个端口， 然后映射到heroku的80端口， 所以后台代码中监听的端口不能写死
	var  port  =  process.env.PORT  ||  5000;
	app.listen(port, () => {console.log(`listen in ${port}`)})
	
```
	
  - 直接在[官网](https://dashboard.heroku.com/apps)添加： 
			 1. 直接关联git仓库
			 2. 添加Procifile 和   修改port端口
			 3. 甚至可以自动部署， 一旦有提交， 就自动deploy

