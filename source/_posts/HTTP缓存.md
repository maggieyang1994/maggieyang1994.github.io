---
title: HTTP缓存
date: 2020-06-20
categories: 
- 计算机网络
rank: 3
tags: 
  - 浏览器缓存
  
---

## 什么是缓存


  缓存是一种保存资源副本，并在下次请求时直接使用该副本的技术。 

  缓存用来缓解服务器端压力，提升性能(获取资源的耗时更短了)。 

  缓存需要合理配置，对一个资源的缓存应截止到其下一次发生改变（即不能缓存过期的资源）



## 缓存的种类
缓存的种类可归为两类：私有与共享缓存。 

私有缓存只针对单个用户，例如浏览器缓存，缓存只影响当前操作浏览器的用户。 

共享缓存会影响到多个用户，例如 ISP(运营商缓存) 缓存，所有访问当前 ISP 的用户都会获取到 ISP 上的缓存资源。

## 缓存控制 
 
### Expires 

Expires 的值为一个 GMT 时间的字符串，表示缓存资源将在这个时间之后过期。 

如果本地时间不超过 Expires 设定的时间，浏览器将会使用缓存的资源，否则将发起请求获取新的资源。 

由于 Expires 的值为服务端时间，如果客户端时间与服务端时间不一致，那么可能会导致缓存失效的问题。 

如果 Cache-Control 响应头设置了 "max-age" 或 "s-max-age" 指令，Expires 头会被忽略。 

 

### Cache-control 

Cache-control 是一个通用 HTTP 头，请求头和响应头都支持。 

通过设定不同的值来定义缓存策略。以下为 Cache-control 头都常用指令。 
1. ### no-store 
  no-store 表示不缓存请求和响应的内容。（强缓存和协商缓存都不用）
2. ### no-cache 
  no-cache 表示资源可以被缓存但不直接使用，需要向服务端发起请求验证，只有 Response 的状态码为 304 时才会使用缓存的资源。 （只使用协商缓存）
3. ### public、private 

  public 表示可以被中间人缓存，private 表示不能被中间人缓存。默认为 private。 
4. ### max-age 

  max-age 表示资源可以被缓存，max-age 指令的值为一个数值，表示当前资源能被 

  缓存的最大秒数（相对于请求的发起时间）。 是一个相对时间， 即使客户端时间不准也没关系， 优先级比expires高


5. ### Etag 

  Etag 作为响应头使用，如果响应头携带了 Etag 返回，浏览器在后续请求中会在请求头中携带 If-None-Match 头，值与 Etag 相同，供服务端验证客户端缓存资源是否有效，可以使用客户端缓存则返回 304。 （一般相对于文件内容缓存，比较准确， 需要读文件内容， 加重服务器负担）

6. ### Last-Modified 

  Last-Modified 也是作为响应头使用，精确度比  ETag 要低，如果响应头携带 了Last-Modified返回，浏览器在后续请求中会在请求头中携带 If-Modified-Since 供服务端验证客户端缓存资源是否有效，可以使用客户端缓存则返回 304。 （一般相对与文件修改时间缓存，不能精确到秒， 对于改动频繁的资源检测不到， 对于ctrl+c, ctrl+v的文件也会被视为有改动）

## 缓存使用场景
### 不可变内容 （强缓存）

不可变内容表示同一个 URL 所对应的资源内容是一直固定不变的。 

例如 domain.com/static/xxx-v1.2.3.js 这个 URL 所对应资源内容永远不会发生改变，那么这就是一个不可变内容。 

由于资源本身是不会改变，最佳实践是为其添加长时间的过期时间，如 Cache-control: max-age=31536000。 

 

### 可变内容  （协商缓存）

相反，可变内容同理。 

例如 domain.com/index.html 这个 URL 所对应资源内容则可能在每次版本发布时都会有所改变。如果为其设置较长的过期时间，则会导致客户端长期使用本地缓存，版本发布会后资源无法同步更新。 

对于可变内容，最佳实践是为其选择需要验证的缓存方式，如 Cache-control: no-cache 配合 Etag。 

## 浏览器刷新方式以及默认行为
### 第一种，地址栏中输入然后回车，或通过书签访问情况如下： 

如果浏览器发现有缓存资源而且没有过期，则直接使用本地缓存。否则发起请求获取新的资源。 

如果浏览器发现有缓存资源但需要验证，则会携带相关头部信息发起请求。 

如果没有有效缓存与需验证缓存，则会直接请求新的资源。 

如果在地址栏输入的地址与当前页面地址相同，则效果等同于第二种使用 F5 刷新页面。 

效果等同于 **must-revalidate**
 

 

###  第二种，F5 或点击工具栏中的刷新按钮，右键菜单重新加载。 

如果浏览器发现有强缓存资源，即使没有过期也不使用，会发起一个新的请求获取新的资源。 

如果浏览器发现有协商缓存资源，则会携带协商缓存相关头部信息发起请求。 

如果没有强缓存与协商缓存，则会直接请求新的资源。 

效果等同于 **no-cache**
 

 

###  第三种，Ctrl + F5 

浏览器不使用强缓存资源，并且发起请求获新的资源，并且这个请求不包含协商缓存相关头部信息。 

这样使得 CDN 或服务无法返回 304，保证获取的是直接从服务返回的最新资源，而不是 CDN 或中间代理的缓存。

效果等同于 **no-store**